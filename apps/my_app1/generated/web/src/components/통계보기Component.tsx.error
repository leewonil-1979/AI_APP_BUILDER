// AR ì†ì”»ê¸° ìŠµê´€ ìœ ë„ - í†µê³„ë³´ê¸° ì»´í¬ë„ŒíŠ¸ (Tier 4 Phase 1: ê³ ê¸‰ ë¶„ì„)
import {
  Box,
  Typography,
  Card,
  CardContent,
  Grid,
  Chip,
  LinearProgress,
  Stack,
  Alert,
  Avatar,
  List,
  ListItem,
  ListItemText,
  ListItemAvatar,
  Divider,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Button,
  ButtonGroup,
  Select,
  MenuItem,
  FormControl,
  InputLabel,
} from "@mui/material";
import { useState, useMemo } from "react";
import { useê¸°ë¡ì¶”ê°€ } from "../store/store";

// ì‹œê°„ ë²”ìœ„ íƒ€ì… ì •ì˜
type TimeRange = "ì¼ì£¼ì¼" | "í•œë‹¬" | "3ê°œì›”" | "ì „ì²´";
type ChartType = "ì¼ë³„" | "ì‹œê°„ëŒ€ë³„" | "í’ˆì§ˆë³„" | "ìœ„ì¹˜ë³„";

// ê³ ê¸‰ í†µê³„ ê³„ì‚° í•¨ìˆ˜ë“¤
const calculateAdvancedStats = (records: any[], timeRange: TimeRange) => {
  const now = new Date();
  const filterDate = new Date();

  // ì‹œê°„ ë²”ìœ„ë³„ í•„í„°ë§
  switch (timeRange) {
    case "ì¼ì£¼ì¼":
      filterDate.setDate(now.getDate() - 7);
      break;
    case "í•œë‹¬":
      filterDate.setMonth(now.getMonth() - 1);
      break;
    case "3ê°œì›”":
      filterDate.setMonth(now.getMonth() - 3);
      break;
    case "ì „ì²´":
      filterDate.setFullYear(2000);
      break;
  }

  const filteredRecords = records.filter((record) => new Date(record.timestamp) >= filterDate);

  // ê¸°ë³¸ í†µê³„
  const totalWashes = filteredRecords.length;
  const avgDuration =
    totalWashes > 0
      ? filteredRecords.reduce((sum, r) => sum + (r.duration || 20), 0) / totalWashes
      : 0;

  // í’ˆì§ˆ ë¶„í¬
  const qualityDistribution = {
    excellent: filteredRecords.filter((r) => r.quality === "excellent").length,
    good: filteredRecords.filter((r) => r.quality === "good").length,
    poor: filteredRecords.filter((r) => r.quality === "poor").length,
  };

  // ìœ„ì¹˜ë³„ í†µê³„
  const locationStats = filteredRecords.reduce((acc, record) => {
    const location = record.location || "ë¯¸ì •";
    acc[location] = (acc[location] || 0) + 1;
    return acc;
  }, {});

  // ì‹œê°„ëŒ€ë³„ ë¶„ì„ (24ì‹œê°„ ê¸°ì¤€)
  const hourlyStats = Array.from({ length: 24 }, (_, i) => ({ hour: i, count: 0 }));
  filteredRecords.forEach((record) => {
    const hour = new Date(record.timestamp).getHours();
    hourlyStats[hour].count++;
  });

  // ì¼ë³„ ë¶„ì„ (ìµœê·¼ 30ì¼)
  const dailyStats = Array.from({ length: 30 }, (_, i) => {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toDateString();
    const count = filteredRecords.filter(
      (r) => new Date(r.timestamp).toDateString() === dateStr,
    ).length;
    return { date: dateStr, count, day: i };
  }).reverse();

  // ì—°ì† ê¸°ë¡ ê³„ì‚°
  let currentStreak = 0;
  let longestStreak = 0;
  let tempStreak = 0;

  for (let i = 0; i < 30; i++) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const hasRecord = filteredRecords.some(
      (r) => new Date(r.timestamp).toDateString() === date.toDateString(),
    );

    if (hasRecord) {
      tempStreak++;
      if (i === 0) currentStreak = tempStreak;
    } else {
      longestStreak = Math.max(longestStreak, tempStreak);
      tempStreak = 0;
    }
  }
  longestStreak = Math.max(longestStreak, tempStreak);

  // AR ì‚¬ìš©ë¥ 
  const arUsage = filteredRecords.filter((r) => r.arUsed).length;
  const arUsageRate = totalWashes > 0 ? (arUsage / totalWashes) * 100 : 0;

  // ì™„ë£Œë„ ë¶„ì„ (6ë‹¨ê³„ ê¸°ì¤€)
  const avgCompletionRate =
    filteredRecords.length > 0
      ? (filteredRecords.reduce((sum, r) => sum + (r.completedSteps?.length || 0) / 6, 0) /
          filteredRecords.length) *
        100
      : 0;

  return {
    totalWashes,
    avgDuration,
    qualityDistribution,
    locationStats,
    hourlyStats,
    dailyStats,
    currentStreak,
    longestStreak,
    arUsageRate,
    avgCompletionRate,
    filteredRecords,
  };
};

// í’ˆì§ˆ ìƒ‰ìƒ ë§¤í•‘
const getQualityColor = (quality: string) => {
  switch (quality) {
    case "excellent":
      return { bg: "#4caf50", text: "ì™„ë²½" };
    case "good":
      return { bg: "#ff9800", text: "ì–‘í˜¸" };
    case "poor":
      return { bg: "#f44336", text: "ê°œì„ í•„ìš”" };
    default:
      return { bg: "#757575", text: "ë¯¸ì •" };
  }
};

export const í†µê³„ë³´ê¸°Component = () => {
  const { ê¸°ë¡ì¶”ê°€Data } = useê¸°ë¡ì¶”ê°€();

  // ìƒíƒœ ê´€ë¦¬
  const [timeRange, setTimeRange] = useState<TimeRange>("ì¼ì£¼ì¼");
  const [chartType, setChartType] = useState<ChartType>("ì¼ë³„");
  const [showDetails, setShowDetails] = useState(false);

  // ê³ ê¸‰ í†µê³„ ê³„ì‚°
  const stats = useMemo(
    () => calculateAdvancedStats(ê¸°ë¡ì¶”ê°€Data, timeRange),
    [ê¸°ë¡ì¶”ê°€Data, timeRange],
  );

  // ì„±ì·¨ ë ˆë²¨ ê³„ì‚°
  const achievementLevel = useMemo(() => {
    const { totalWashes, currentStreak, avgCompletionRate } = stats;

    if (totalWashes >= 100 && currentStreak >= 30 && avgCompletionRate >= 90) {
      return { level: "ë§ˆìŠ¤í„°", icon: "ğŸ†", color: "#ffd700", description: "ì†ì”»ê¸° ë§ˆìŠ¤í„°!" };
    } else if (totalWashes >= 50 && currentStreak >= 14 && avgCompletionRate >= 80) {
      return {
        level: "ì „ë¬¸ê°€",
        icon: "â­",
        color: "#ff6b35",
        description: "í›Œë¥­í•œ ìŠµê´€ì„ ìœ ì§€í•˜ê³  ìˆì–´ìš”",
      };
    } else if (totalWashes >= 20 && currentStreak >= 7 && avgCompletionRate >= 70) {
      return {
        level: "ìˆ™ë ¨ì",
        icon: "ğŸ¯",
        color: "#4ecdc4",
        description: "ì¢‹ì€ ìŠµê´€ì´ ìë¦¬ì¡ê³  ìˆì–´ìš”",
      };
    } else if (totalWashes >= 5 && avgCompletionRate >= 60) {
      return { level: "ì´ˆë³´ì", icon: "ğŸŒ±", color: "#95e1d3", description: "ì¢‹ì€ ì‹œì‘ì´ì—ìš”!" };
    }
    return { level: "ì‹œì‘", icon: "ğŸ‘¶", color: "#f8f9fa", description: "ì²« ê±¸ìŒì„ ì‹œì‘í•´ë³´ì„¸ìš”" };
  }, [stats]);

  // ê°œì„  ì œì•ˆ ìƒì„±
  const improvementSuggestions = useMemo(() => {
    const suggestions = [];
    const { qualityDistribution, avgDuration, arUsageRate, currentStreak, locationStats } = stats;

    if (qualityDistribution.poor > qualityDistribution.excellent) {
      suggestions.push({
        type: "quality",
        icon: "ğŸ¯",
        title: "ì†ì”»ê¸° í’ˆì§ˆ ê°œì„ ",
        description: "ë” ê¼¼ê¼¼í•˜ê²Œ 6ë‹¨ê³„ë¥¼ ëª¨ë‘ ì™„ë£Œí•´ë³´ì„¸ìš”",
        color: "#f44336",
      });
    }

    if (avgDuration < 20) {
      suggestions.push({
        type: "duration",
        icon: "â±ï¸",
        title: "ì†ì”»ê¸° ì‹œê°„ ëŠ˜ë¦¬ê¸°",
        description: "WHO ê¶Œì¥ 20ì´ˆ ì´ìƒ ì†ì”»ê¸°ë¥¼ ì‹¤ì²œí•´ë³´ì„¸ìš”",
        color: "#ff9800",
      });
    }

    if (arUsageRate < 50) {
      suggestions.push({
        type: "ar",
        icon: "ğŸ“±",
        title: "AR ê¸°ëŠ¥ í™œìš©",
        description: "AR ê°€ì´ë“œë¡œ ë” ì •í™•í•œ ì†ì”»ê¸°ë¥¼ ì—°ìŠµí•´ë³´ì„¸ìš”",
        color: "#9c27b0",
      });
    }

    if (currentStreak < 3) {
      suggestions.push({
        type: "consistency",
        icon: "ğŸ“…",
        title: "ê¾¸ì¤€í•¨ ë§Œë“¤ê¸°",
        description: "ë§¤ì¼ ê¾¸ì¤€íˆ ê¸°ë¡í•´ì„œ ìŠµê´€ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”",
        color: "#2196f3",
      });
    }

    const homeWashes = locationStats["ì§‘"] || 0;
    const totalWashes = Object.values(locationStats).reduce(
      (sum: number, count) => sum + (count as number),
      0,
    );
    if (homeWashes < totalWashes * 0.3 && totalWashes > 0) {
      suggestions.push({
        type: "location",
        icon: "ğŸ ",
        title: "ì§‘ì—ì„œë„ ì‹¤ì²œí•˜ê¸°",
        description: "ì§‘ì—ì„œì˜ ì†ì”»ê¸°ë„ ê¾¸ì¤€íˆ ê¸°ë¡í•´ë³´ì„¸ìš”",
        color: "#4caf50",
      });
    }

    return suggestions.slice(0, 3); // ìµœëŒ€ 3ê°œ ì œì•ˆ
  }, [stats]);

  return (
    <Box sx={{ p: 3 }}>
      <Stack spacing={3}>
        {/* í—¤ë” ë° í•„í„° */}
        <Box
          sx={{
            display: "flex",
            justifyContent: "space-between",
            alignItems: "center",
            flexWrap: "wrap",
            gap: 2,
          }}
        >
          <Box>
            <Typography variant="h4" component="h1" gutterBottom>
              ğŸ“Š ê³ ê¸‰ í†µê³„ ë¶„ì„
            </Typography>
            <Typography variant="subtitle1" color="textSecondary">
              AI ê¸°ë°˜ ìƒì„¸ ë¶„ì„ ë° ê°œì¸í™”ëœ ì¸ì‚¬ì´íŠ¸
            </Typography>
          </Box>

          <Stack direction="row" spacing={2}>
            <FormControl size="small" sx={{ minWidth: 120 }}>
              <InputLabel>ê¸°ê°„</InputLabel>
              <Select
                value={timeRange}
                onChange={(e) => setTimeRange(e.target.value as TimeRange)}
                label="ê¸°ê°„"
              >
                <MenuItem value="ì¼ì£¼ì¼">ì¼ì£¼ì¼</MenuItem>
                <MenuItem value="í•œë‹¬">í•œë‹¬</MenuItem>
                <MenuItem value="3ê°œì›”">3ê°œì›”</MenuItem>
                <MenuItem value="ì „ì²´">ì „ì²´</MenuItem>
              </Select>
            </FormControl>

            <ButtonGroup size="small">
              <Button
                variant={chartType === "ì¼ë³„" ? "contained" : "outlined"}
                onClick={() => setChartType("ì¼ë³„")}
              >
                ì¼ë³„
              </Button>
              <Button
                variant={chartType === "ì‹œê°„ëŒ€ë³„" ? "contained" : "outlined"}
                onClick={() => setChartType("ì‹œê°„ëŒ€ë³„")}
              >
                ì‹œê°„ëŒ€ë³„
              </Button>
              <Button
                variant={chartType === "í’ˆì§ˆë³„" ? "contained" : "outlined"}
                onClick={() => setChartType("í’ˆì§ˆë³„")}
              >
                í’ˆì§ˆë³„
              </Button>
            </ButtonGroup>
          </Stack>
        </Box>
        {/* ì„±ì·¨ ë ˆë²¨ ì¹´ë“œ */}
        <Card
          sx={{
            background: `linear-gradient(135deg, ${achievementLevel.color}20, ${achievementLevel.color}10)`,
            border: `2px solid ${achievementLevel.color}`,
          }}
        >
          <CardContent>
            <Stack direction="row" alignItems="center" spacing={3}>
              <Avatar
                sx={{
                  bgcolor: achievementLevel.color,
                  width: 80,
                  height: 80,
                  fontSize: "2rem",
                }}
              >
                {achievementLevel.icon}
              </Avatar>
              <Box flex={1}>
                <Typography variant="h5" fontWeight="bold" color={achievementLevel.color}>
                  {achievementLevel.level} ë ˆë²¨
                </Typography>
                <Typography variant="body1" sx={{ mt: 1 }}>
                  {achievementLevel.description}
                </Typography>
                <Stack direction="row" spacing={2} sx={{ mt: 2 }}>
                  <Chip label={`ì´ ${stats.totalWashes}íšŒ`} size="small" />
                  <Chip label={`${stats.currentStreak}ì¼ ì—°ì†`} size="small" />
                  <Chip label={`ì™„ë£Œë„ ${stats.avgCompletionRate.toFixed(1)}%`} size="small" />
                </Stack>
              </Box>
            </Stack>
          </CardContent>
        </Card>
        {/* í•µì‹¬ ì§€í‘œ */}
        <Stack direction="row" spacing={3} sx={{ flexWrap: "wrap" }}>
          <Card sx={{ flex: 1, minWidth: 250 }}>
            <CardContent sx={{ textAlign: "center" }}>
              <Avatar sx={{ bgcolor: "#2196f3", mx: "auto", mb: 2, width: 56, height: 56 }}>
                <Typography variant="h5">ğŸš¿</Typography>
              </Avatar>
              <Typography variant="h4" color="primary" fontWeight="bold">
                {stats.totalWashes}
              </Typography>
              <Typography variant="body2" color="textSecondary">
                ì´ ì†ì”»ê¸° íšŸìˆ˜
              </Typography>
              <Typography variant="caption" color="textSecondary">
                ({timeRange} ê¸°ì¤€)
              </Typography>
            </CardContent>
          </Card>

          <Card sx={{ flex: 1, minWidth: 250 }}>
            <CardContent sx={{ textAlign: "center" }}>
              <Avatar sx={{ bgcolor: "#4caf50", mx: "auto", mb: 2, width: 56, height: 56 }}>
                <Typography variant="h5">â±ï¸</Typography>
              </Avatar>
              <Typography variant="h4" color="success.main" fontWeight="bold">
                {stats.avgDuration.toFixed(1)}
              </Typography>
              <Typography variant="body2" color="textSecondary">
                í‰ê·  ì†Œìš”ì‹œê°„ (ì´ˆ)
              </Typography>
              <LinearProgress
                variant="determinate"
                value={Math.min(100, (stats.avgDuration / 30) * 100)}
                sx={{ mt: 1 }}
              />
            </CardContent>
          </Card>

          <Card sx={{ flex: 1, minWidth: 250 }}>
            <CardContent sx={{ textAlign: "center" }}>
              <Avatar sx={{ bgcolor: "#ff9800", mx: "auto", mb: 2, width: 56, height: 56 }}>
                <Typography variant="h5">ğŸ”¥</Typography>
              </Avatar>
              <Typography variant="h4" color="warning.main" fontWeight="bold">
                {stats.currentStreak}
              </Typography>
              <Typography variant="body2" color="textSecondary">
                í˜„ì¬ ì—°ì† ê¸°ë¡ (ì¼)
              </Typography>
              <Typography variant="caption" color="textSecondary">
                ìµœê³ : {stats.longestStreak}ì¼
              </Typography>
            </CardContent>
          </Card>

          <Card sx={{ flex: 1, minWidth: 250 }}>
            <CardContent sx={{ textAlign: "center" }}>
              <Avatar sx={{ bgcolor: "#9c27b0", mx: "auto", mb: 2, width: 56, height: 56 }}>
                <Typography variant="h5">ğŸ“±</Typography>
              </Avatar>
              <Typography variant="h4" color="secondary.main" fontWeight="bold">
                {stats.arUsageRate.toFixed(1)}%
              </Typography>
              <Typography variant="body2" color="textSecondary">
                AR ê¸°ëŠ¥ ì‚¬ìš©ë¥ 
              </Typography>
              <LinearProgress
                variant="determinate"
                value={stats.arUsageRate}
                color="secondary"
                sx={{ mt: 1 }}
              />
            </CardContent>
          </Card>
        </Stack>{" "}
        {/* ì°¨íŠ¸ ì˜ì—­ */}
        <Card>
          <CardContent>
            <Typography variant="h6" gutterBottom>
              ğŸ“ˆ {chartType} ë¶„ì„ ({timeRange})
            </Typography>

            {chartType === "ì¼ë³„" && (
              <Box sx={{ mt: 2 }}>
                <Typography variant="body2" color="textSecondary" sx={{ mb: 2 }}>
                  ìµœê·¼ 30ì¼ê°„ ì¼ë³„ ì†ì”»ê¸° íŒ¨í„´
                </Typography>
                <Stack spacing={1}>
                  {stats.dailyStats.slice(-10).map((day) => (
                    <Box key={day.date} sx={{ display: "flex", alignItems: "center", gap: 2 }}>
                      <Typography variant="body2" sx={{ minWidth: 80, fontSize: "0.8rem" }}>
                        {new Date(day.date).toLocaleDateString("ko-KR", {
                          month: "short",
                          day: "numeric",
                        })}
                      </Typography>
                      <LinearProgress
                        variant="determinate"
                        value={
                          day.count > 0
                            ? Math.min(
                                100,
                                (day.count /
                                  Math.max(1, Math.max(...stats.dailyStats.map((d) => d.count)))) *
                                  100,
                              )
                            : 0
                        }
                        sx={{ flex: 1, height: 8 }}
                      />
                      <Typography variant="body2" sx={{ minWidth: 30, textAlign: "right" }}>
                        {day.count}íšŒ
                      </Typography>
                    </Box>
                  ))}
                </Stack>
              </Box>
            )}

            {chartType === "ì‹œê°„ëŒ€ë³„" && (
              <Box sx={{ mt: 2 }}>
                <Typography variant="body2" color="textSecondary" sx={{ mb: 2 }}>
                  24ì‹œê°„ ê¸°ì¤€ ì‹œê°„ëŒ€ë³„ ì†ì”»ê¸° ë¹ˆë„
                </Typography>
                <Grid container spacing={1}>
                  {[0, 1, 2, 3, 4, 5].map((period) => {
                    const startHour = period * 4;
                    const endHour = startHour + 3;
                    const periodCount = stats.hourlyStats
                      .slice(startHour, endHour + 1)
                      .reduce((sum, h) => sum + h.count, 0);
                    const maxCount = Math.max(...stats.hourlyStats.map((h) => h.count));

                    return (
                      <Grid item xs={2} key={period}>
                        <Paper sx={{ p: 2, textAlign: "center" }}>
                          <Typography variant="caption" color="textSecondary">
                            {startHour}:00-{endHour + 1}:00
                          </Typography>
                          <Typography variant="h6" color="primary">
                            {periodCount}
                          </Typography>
                          <LinearProgress
                            variant="determinate"
                            value={maxCount > 0 ? (periodCount / maxCount) * 100 : 0}
                            sx={{ mt: 1 }}
                          />
                        </Paper>
                      </Grid>
                    );
                  })}
                </Grid>
              </Box>
            )}

            {chartType === "í’ˆì§ˆë³„" && (
              <Box sx={{ mt: 2 }}>
                <Typography variant="body2" color="textSecondary" sx={{ mb: 2 }}>
                  ì†ì”»ê¸° í’ˆì§ˆ ë¶„í¬ ë° ë¶„ì„
                </Typography>
                <Stack spacing={2}>
                  {Object.entries(stats.qualityDistribution).map(([quality, count]) => {
                    const { bg, text } = getQualityColor(quality);
                    const percentage =
                      stats.totalWashes > 0 ? (count / stats.totalWashes) * 100 : 0;

                    return (
                      <Box key={quality} sx={{ display: "flex", alignItems: "center", gap: 2 }}>
                        <Avatar sx={{ bgcolor: bg, width: 32, height: 32 }}>
                          <Typography variant="caption" color="white">
                            {count}
                          </Typography>
                        </Avatar>
                        <Box flex={1}>
                          <Typography variant="body2" fontWeight="bold">
                            {text}
                          </Typography>
                          <LinearProgress
                            variant="determinate"
                            value={percentage}
                            sx={{ mt: 0.5, "& .MuiLinearProgress-bar": { bgcolor: bg } }}
                          />
                        </Box>
                        <Typography variant="body2" sx={{ minWidth: 60, textAlign: "right" }}>
                          {percentage.toFixed(1)}%
                        </Typography>
                      </Box>
                    );
                  })}
                </Stack>
              </Box>
            )}
          </CardContent>
        </Card>
        {/* ê°œì„  ì œì•ˆ */}
        {improvementSuggestions.length > 0 && (
          <Card>
            <CardContent>
              <Typography variant="h6" gutterBottom>
                ğŸ’¡ AI ë§ì¶¤ ê°œì„  ì œì•ˆ
              </Typography>
              <Stack spacing={2}>
                {improvementSuggestions.map((suggestion, index) => (
                  <Alert
                    key={index}
                    icon={<span style={{ fontSize: "1.2rem" }}>{suggestion.icon}</span>}
                    severity="info"
                    sx={{ "& .MuiAlert-icon": { color: suggestion.color } }}
                  >
                    <Typography variant="subtitle2" fontWeight="bold">
                      {suggestion.title}
                    </Typography>
                    <Typography variant="body2">{suggestion.description}</Typography>
                  </Alert>
                ))}
              </Stack>
            </CardContent>
          </Card>
        )}
        {/* ìœ„ì¹˜ë³„ í†µê³„ */}
        <Card>
          <CardContent>
            <Typography variant="h6" gutterBottom>
              ğŸ“ ìœ„ì¹˜ë³„ ì†ì”»ê¸° ë¶„ì„
            </Typography>
            <Stack spacing={2}>
              {Object.entries(stats.locationStats)
                .sort(([, a], [, b]) => (b as number) - (a as number))
                .map(([location, count]) => {
                  const percentage =
                    stats.totalWashes > 0 ? ((count as number) / stats.totalWashes) * 100 : 0;
                  const locationEmoji: Record<string, string> = {
                    ì§‘: "ğŸ ",
                    íšŒì‚¬: "ğŸ¢",
                    ì‹ë‹¹: "ğŸ½ï¸",
                    í™”ì¥ì‹¤: "ğŸš»",
                    ê¸°íƒ€: "ğŸŒ",
                  };

                  return (
                    <Box key={location} sx={{ display: "flex", alignItems: "center", gap: 2 }}>
                      <Avatar sx={{ bgcolor: "#2196f3", width: 40, height: 40 }}>
                        <Typography>{locationEmoji[location] || "ğŸ“"}</Typography>
                      </Avatar>
                      <Box flex={1}>
                        <Typography variant="body1" fontWeight="bold">
                          {location}
                        </Typography>
                        <LinearProgress variant="determinate" value={percentage} sx={{ mt: 0.5 }} />
                      </Box>
                      <Stack alignItems="flex-end">
                        <Typography variant="h6" color="primary">
                          {count as number}íšŒ
                        </Typography>
                        <Typography variant="caption" color="textSecondary">
                          {percentage.toFixed(1)}%
                        </Typography>
                      </Stack>
                    </Box>
                  );
                })}
            </Stack>
          </CardContent>
        </Card>
        {/* ìƒì„¸ ê¸°ë¡ í…Œì´ë¸” */}
        <Card>
          <CardContent>
            <Box
              sx={{ display: "flex", justifyContent: "space-between", alignItems: "center", mb: 2 }}
            >
              <Typography variant="h6">ğŸ“‹ ìƒì„¸ ê¸°ë¡ ({timeRange})</Typography>
              <Button size="small" onClick={() => setShowDetails(!showDetails)}>
                {showDetails ? "ê°„ë‹¨íˆ ë³´ê¸°" : "ìì„¸íˆ ë³´ê¸°"}
              </Button>
            </Box>

            {showDetails ? (
              <TableContainer component={Paper} variant="outlined">
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      <TableCell>ë‚ ì§œ</TableCell>
                      <TableCell>ì†Œìš”ì‹œê°„</TableCell>
                      <TableCell>í’ˆì§ˆ</TableCell>
                      <TableCell>ìœ„ì¹˜</TableCell>
                      <TableCell>ì™„ë£Œë‹¨ê³„</TableCell>
                      <TableCell>ARì‚¬ìš©</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {stats.filteredRecords
                      .slice(-10)
                      .reverse()
                      .map((record) => (
                        <TableRow key={record.id}>
                          <TableCell>
                            <Typography variant="body2">
                              {new Date(record.timestamp).toLocaleString("ko-KR", {
                                month: "short",
                                day: "numeric",
                                hour: "2-digit",
                                minute: "2-digit",
                              })}
                            </Typography>
                          </TableCell>
                          <TableCell>
                            <Typography variant="body2">{record.duration || 20}ì´ˆ</Typography>
                          </TableCell>
                          <TableCell>
                            <Chip
                              label={getQualityColor(record.quality).text}
                              size="small"
                              sx={{
                                bgcolor: getQualityColor(record.quality).bg,
                                color: "white",
                                fontSize: "0.7rem",
                              }}
                            />
                          </TableCell>
                          <TableCell>
                            <Typography variant="body2">{record.location || "ë¯¸ì •"}</Typography>
                          </TableCell>
                          <TableCell>
                            <Typography variant="body2">
                              {record.completedSteps?.length || 0}/6
                            </Typography>
                          </TableCell>
                          <TableCell>
                            <Chip
                              label={record.arUsed ? "AR" : "ì¼ë°˜"}
                              size="small"
                              color={record.arUsed ? "secondary" : "default"}
                            />
                          </TableCell>
                        </TableRow>
                      ))}
                  </TableBody>
                </Table>
              </TableContainer>
            ) : (
              <List>
                {stats.filteredRecords
                  .slice(-5)
                  .reverse()
                  .map((record, index) => (
                    <Box key={record.id}>
                      <ListItem>
                        <ListItemAvatar>
                          <Avatar sx={{ bgcolor: getQualityColor(record.quality).bg }}>
                            <Typography variant="caption" color="white">
                              {record.duration || 20}s
                            </Typography>
                          </Avatar>
                        </ListItemAvatar>
                        <ListItemText
                          primary={
                            <Stack direction="row" spacing={1} alignItems="center">
                              <Typography variant="body2" fontWeight="bold">
                                {record.location || "ë¯¸ì •"}
                              </Typography>
                              <Chip label={getQualityColor(record.quality).text} size="small" />
                              {record.arUsed && <Chip label="AR" size="small" color="secondary" />}
                            </Stack>
                          }
                          secondary={
                            <Typography variant="caption" color="textSecondary">
                              {record.timestamp} â€¢ {record.completedSteps?.length || 0}/6 ë‹¨ê³„ ì™„ë£Œ
                            </Typography>
                          }
                        />
                      </ListItem>
                      {index < 4 && <Divider />}
                    </Box>
                  ))}
              </List>
            )}
          </CardContent>
        </Card>
        {ê¸°ë¡ì¶”ê°€Data.length === 0 && (
          <Alert severity="info" sx={{ textAlign: "center" }}>
            <Typography variant="h6" gutterBottom>
              ğŸ“Š ì•„ì§ ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
            </Typography>
            <Typography variant="body2">
              AR ì†ì”»ê¸° ê¸°ë¡ì„ ì‹œì‘í•˜ë©´ ìƒì„¸í•œ í†µê³„ì™€ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•´ë“œë¦´ê²Œìš”!
            </Typography>
          </Alert>
        )}
      </Stack>
    </Box>
  );
};
